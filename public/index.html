<!-- ---------- Paste Supabase Code Below This Line ---------- -->

<script>
/* ------------------------------
   Full portal JavaScript — Pro
   ------------------------------ */

/* helpers */
const $ = id => document.getElementById(id);
function esc(s){ if(s===undefined||s===null) return ''; return String(s).replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch])); }
function today(){ return new Date().toISOString().slice(0,10); }

// Initialize Supabase
const SUPABASE_URL = "https://sasodvdokwybanovtuwl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhc29kdmRva3d5YmFub3Z0dXdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzMzNTAsImV4cCI6MjA3MDc0OTM1MH0.sUJx73vkjPlKo9m8De6dUNGMcdWjb1vh8hnsMBVMgRQ";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* storage initialization */
function ensureStorage(){
  if(!localStorage.getItem('users')) {
    const sample = {teacher1:'pass1',teacher2:'pass2',teacher3:'pass3'};
    localStorage.setItem('users', JSON.stringify(sample));
  }
}

/* ----------------------------------------------------------------------------
   SUPABASE DATABASE FUNCTIONS (REPLACES LOCALSTORAGE)
   ---------------------------------------------------------------------------- */

// Initialize Supabase
let currentData = {
  students: [],
  attendance: {},
  meetings: [],
  lessons: []
};

let isInitialized = false;

async function initializeData() {
  if (isInitialized) return currentData;
  
  try {
    const { data, error } = await supabaseClient
      .from('portal_data')
      .select('*');
    
    if (error) throw error;
    
    if (data && data.length > 0) {
      data.forEach(item => {
        if (item.data_type === 'students') currentData.students = item.data || [];
        if (item.data_type === 'attendance') currentData.attendance = item.data || {};
        if (item.data_type === 'meetings') currentData.meetings = item.data || [];
        if (item.data_type === 'lessons') currentData.lessons = item.data || [];
      });
    }
    
    isInitialized = true;
    return currentData;
  } catch (error) {
    console.error('Error initializing data:', error);
    return currentData;
  }
}

async function db() {
  if (!isInitialized) {
    await initializeData();
  }
  return currentData;
}

async function saveDB(newData) {
  try {
    currentData = { ...newData };
    
    // Update all data in parallel
    const updates = [
      { data_type: 'students', data: newData.students },
      { data_type: 'attendance', data: newData.attendance },
      { data_type: 'meetings', data: newData.meetings },
      { data_type: 'lessons', data: newData.lessons }
    ].map(async (update) => {
      const { error } = await supabaseClient
        .from('portal_data')
        .upsert({
          data_type: update.data_type,
          data: update.data,
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'data_type'
        });
      
      if (error) throw error;
    });

    await Promise.all(updates);
    
    // Trigger live update for other clients
    await supabaseClient
      .channel('portal-updates')
      .send({
        type: 'broadcast',
        event: 'data-updated',
        payload: { updated_at: new Date().toISOString() }
      });
      
    return true;
  } catch (error) {
    console.error('Error saving data:', error);
    alert('Error saving data: ' + error.message);
    return false;
  }
}

// Set up real-time updates
function setupRealtimeUpdates() {
  const channel = supabaseClient
    .channel('portal-data')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'portal_data' },
      (payload) => {
        console.log('Data changed!', payload);
        refreshAll();
      }
    )
    .on(
      'broadcast',
      { event: 'data-updated' },
      (payload) => {
        console.log('Data updated by another client', payload);
        // Reload data when another user makes changes
        isInitialized = false;
        refreshAll();
      }
    )
    .subscribe();
}

/* auth logic */
function bindAuth(){
  $('btnRegister').addEventListener('click', ()=>{
    const u = $('regUser').value.trim(); const p = $('regPass').value.trim();
    if(!u || !p) return alert('Enter username and password');
    const users = JSON.parse(localStorage.getItem('users')||'{}');
    if(users[u]) return alert('Username exists');
    users[u] = p; localStorage.setItem('users', JSON.stringify(samples));
    localStorage.setItem('loggedInUser', u);
    openApp(u);
  });

  $('btnLogin').addEventListener('click', ()=>{
    const u = $('loginUser').value.trim(); const p = $('loginPass').value.trim();
    const users = JSON.parse(localStorage.getItem('users')||'{}');
    if(users[u] && users[u] === p){
      localStorage.setItem('loggedInUser', u);
      openApp(u);
    } else alert('Invalid credentials');
  });
}

/* open app after auth */
function openApp(user){
  $('authScreen').style.display = 'none';
  document.querySelector('.app').style.display = 'flex';
  $('currentUser').innerText = user;
  // set default dates
  $('attDate').value = today(); $('lsDate').value = today(); $('mtDate').value = today();
  // show default section
  navigate('dashboard');
  // populate selects/tables
  refreshAll();
  // update clock
  $('currentTime').innerText = new Date().toLocaleString();
  setInterval(()=> $('currentTime').innerText = new Date().toLocaleString(), 60*1000);
  
  // Setup real-time updates
  setupRealtimeUpdates();
}

/* navigation */
function hideAll(){ ['dashboard','students','attendance','meetings','lessons'].forEach(s => $(s).classList.add('hidden')); }
function navigate(section){
  hideAll();
  $(section).classList.remove('hidden');
  if(section==='students') renderStudents();
  if(section==='attendance') renderAttendanceForDate();
  if(section==='meetings') renderMeetingsRange();
  if(section==='lessons'){ populateStudentSelect(); renderLessonsRange(); }
}

/* logout */
function logout(){ localStorage.removeItem('loggedInUser'); location.reload(); }

/* refresh summary */
async function refreshSummary(){
  const d = await db();
  $('totalStudents').innerText = d.students.length;
  $('attendanceDays').innerText = Object.keys(d.attendance).length;
  $('meetingsCount').innerText = d.meetings.length;
  $('lessonsCount').innerText = d.lessons.length;
}

/* -------------------------
   Students
   ------------------------- */
let editingStudent = null;

function bindStudentForm(){
  $('studentForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const d = await db();
    const rec = {
      name: $('stuName').value.trim(),
      age: parseInt($('stuAge').value||'0',10),
      grade: $('stuGrade').value.trim(),
      level: $('stuLevel').value.trim()
    };
    if(!rec.name) return alert('Enter student name');
    if(editingStudent === null) d.students.push(rec);
    else d.students[editingStudent] = rec;
    
    const success = await saveDB(d);
    if (success) {
      cancelEdit('student');
      renderStudents();
      populateStudentSelect();
      refreshSummary();
    }
  });
}

async function renderStudents(){
  const d = await db();
  const tbody = $('studentsTable').querySelector('tbody');
  tbody.innerHTML = '';
  const q = ($('studentSearch').value||'').trim().toLowerCase();
  
  d.students.forEach((s, i) => {
    if(q && !(s.name.toLowerCase().includes(q) || (s.grade||'').toLowerCase().includes(q))) return;
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${esc(s.name)}</td><td>${s.age}</td><td>${esc(s.grade)}</td><td>${esc(s.level)}</td>
      <td>
        <button class="action-btn edit" onclick="editStudent(${i})">Edit</button>
        <button class="action-btn del" onclick="deleteStudent(${i})">Delete</button>
      </td>
    </tr>`);
  });
}

function editStudent(i){
  const s = currentData.students[i];
  if(!s) return;
  $('stuName').value = s.name;
  $('stuAge').value = s.age;
  $('stuGrade').value = s.grade;
  $('stuLevel').value = s.level;
  editingStudent = i;
  $('studentEditingBadge').classList.remove('hidden');
  $('cancelStudent').style.display = 'inline-block';
}

async function deleteStudent(i){
  if(!confirm('Delete this student?')) return;
  const d = await db();
  d.students.splice(i,1);
  const success = await saveDB(d);
  if (success) {
    renderStudents();
    populateStudentSelect();
    refreshSummary();
  }
}

function cancelEdit(type){
  if(type==='student'){
    editingStudent = null;
    $('studentForm').reset();
    $('studentEditingBadge').classList.add('hidden');
    $('cancelStudent').style.display='none';
  }
  if(type==='meeting'){
    editingMeeting = null;
    $('meetingForm').reset();
    actionItems = [];
    renderActionItems();
    $('cancelMeeting').style.display='none';
  }
  if(type==='lesson'){
    editingLesson = null;
    $('lessonForm').reset();
    $('cancelLesson').style.display='none';
  }
}

async function exportStudentsCSV(){
  const d = await db();
  if(!d.students.length) return alert('No students to export');
  const rows = [['Name','Age','Grade','Level'], ...d.students.map(s=>[s.name,s.age,s.grade,s.level])];
  const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'}), url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'students.csv'; a.click(); URL.revokeObjectURL(url);
}

/* -------------------------
   Attendance
   ------------------------- */
async function loadAttendanceForDate(){
  const date = $('attDate').value;
  const d = await db();
  const tbody = $('attendanceTable').querySelector('tbody');
  tbody.innerHTML = '';
  
  if(!date){ tbody.innerHTML = '<tr><td colspan="3">Pick a date</td></tr>'; return; }
  if(!d.students.length){ tbody.innerHTML = '<tr><td colspan="3">No students — add students first</td></tr>'; return; }
  
  const day = d.attendance[date] || [];
  d.students.forEach((s, idx) => {
    const rec = day.find(r => r.student === s.name);
    const status = rec ? rec.status : 'Present';
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${date}</td>
      <td>${esc(s.name)}</td>
      <td>
        <select data-idx="${idx}" style="min-width:140px">
          <option value="Present" ${status==='Present'?'selected':''}>Present</option>
          <option value="Absent" ${status==='Absent'?'selected':''}>Absent</option>
          <option value="Holiday" ${status==='Holiday'?'selected':''}>Holiday</option>
        </select>
      </td>
    </tr>`);
  });
}

function markAll(val){
  document.querySelectorAll('#attendanceTable select').forEach(s => s.value = val);
}

async function saveAttendance(){
  const date = $('attDate').value;
  if(!date) return alert('Pick a date first');
  
  const selects = Array.from(document.querySelectorAll('#attendanceTable select'));
  if(selects.length === 0) return alert('Load students first');
  
  const d = await db();
  d.attendance[date] = selects.map(sel => ({
    student: d.students[parseInt(sel.dataset.idx,10)].name,
    status: sel.value
  }));
  
  const success = await saveDB(d);
  if (success) {
    alert('Attendance saved');
    refreshSummary();
  }
}

async function loadAttendanceRange(){
  const start = $('attStart').value;
  const end = $('attEnd').value;
  const d = await db();
  const tbody = $('attendanceTable').querySelector('tbody');
  tbody.innerHTML = '';
  
  let any = false;
  Object.keys(d.attendance).sort().forEach(date => {
    if((!start || date>=start) && (!end || date<=end)){
      d.attendance[date].forEach(r => {
        any = true;
        tbody.insertAdjacentHTML('beforeend', `<tr><td>${date}</td><td>${esc(r.student)}</td><td>${r.status}</td></tr>`);
      });
    }
  });
  
  if(!any) tbody.innerHTML = '<tr><td colspan="3">No records in selected range.</td></tr>';
}

async function exportAttendanceExcel(){
  const start = $('attStart').value;
  const end = $('attEnd').value;
  const d = await db();
  
  const rows = [];
  Object.keys(d.attendance).sort().forEach(date => {
    if((!start || date>=start) && (!end || date<=end)){
      d.attendance[date].forEach(r => rows.push({ Date: date, Student: r.student, Status: r.status }));
    }
  });
  
  if(!rows.length) return alert('No attendance records to export in selected range');
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
  XLSX.writeFile(wb, 'Attendance.xlsx');
}

/* -------------------------
   Meetings — Pro
   ------------------------- */
let editingMeeting = null;
let actionItems = [];

function bindMeetingForm(){
  $('meetingForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const d = await db();
    
    const selected = Array.from($('mtParticipants').selectedOptions).map(o => o.value).filter(Boolean);
    const free = $('mtParticipantsFree').value.split(',').map(s=>s.trim()).filter(Boolean);
    
    const rec = {
      date: $('mtDate').value,
      startTime: $('mtStartTime').value,
      endTime: $('mtEndTime').value,
      title: $('mtTitle').value.trim(),
      location: $('mtLocation').value.trim(),
      participants: [...new Set([...selected,...free])],
      agenda: $('mtAgenda').value.trim(),
      decisions: $('mtDecisions').value.trim(),
      actions: actionItems.slice()
    };
    
    if(!rec.date || !rec.title) return alert('Date and title required');
    
    if(editingMeeting === null) d.meetings.push(rec);
    else d.meetings[editingMeeting] = rec;
    
    const success = await saveDB(d);
    if (success) {
      cancelEdit('meeting');
      renderMeetingsRange();
      refreshSummary();
    }
  });
}

function addActionItem(){
  const t = $('aiText').value.trim();
  const o = $('aiOwner').value.trim();
  const due = $('aiDue').value;
  const st = $('aiStatus').value;
  
  if(!t) return alert('Action item needs description');
  actionItems.push({text:t, owner:o, due:due, status:st});
  
  $('aiText').value='';
  $('aiOwner').value='';
  $('aiDue').value='';
  $('aiStatus').value='Open';
  renderActionItems();
}

function removeActionItem(idx){
  actionItems.splice(idx,1);
  renderActionItems();
}

function renderActionItems(){
  const tbody = $('actionsTable').querySelector('tbody');
  tbody.innerHTML='';
  
  actionItems.forEach((a,i)=>{
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${i+1}</td>
      <td>${esc(a.text)}</td>
      <td>${esc(a.owner)}</td>
      <td>${esc(a.due)}</td>
      <td>${esc(a.status)}</td>
      <td><button class="action-btn del" onclick="removeActionItem(${i})">Remove</button></td>
    </tr>`);
  });
}

async function renderMeetingsRange(){
  populateParticipantSelect();
  const start = $('mtStart').value;
  const end = $('mtEnd').value;
  const d = await db();
  const tbody = $('meetingsTable').querySelector('tbody');
  tbody.innerHTML = '';
  
  d.meetings.forEach((m,i) => {
    if((!start || m.date>=start) && (!end || m.date<=end)){
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${m.date} ${m.startTime?('• '+m.startTime):''}</td>
        <td>${esc(m.title)}</td>
        <td>${esc((m.participants||[]).join(', '))}</td>
        <td>
          <button class="action-btn edit" onclick="editMeeting(${i})">Edit</button>
          <button class="action-btn del" onclick="deleteMeeting(${i})">Delete</button>
          <button class="action-btn link" onclick="exportSingleMeetingPDF(${i})">PDF</button>
        </td>
      </tr>`);
    }
  });
}

function populateParticipantSelect(){
  const mtSel = $('mtParticipants');
  mtSel.innerHTML='';
  
  currentData.students.forEach(s => {
    const o=document.createElement('option');
    o.value=s.name;
    o.textContent=s.name;
    mtSel.appendChild(o);
  });
}

function editMeeting(i){
  const m = currentData.meetings[i];
  if(!m) return;
  
  $('mtDate').value = m.date;
  $('mtStartTime').value=m.startTime||'';
  $('mtEndTime').value=m.endTime||'';
  $('mtTitle').value = m.title;
  $('mtLocation').value = m.location||'';
  $('mtAgenda').value = m.agenda||'';
  $('mtDecisions').value = m.decisions||'';
  $('mtParticipantsFree').value='';
  
  Array.from($('mtParticipants').options).forEach(opt => {
    opt.selected = (m.participants||[]).includes(opt.value);
  });
  
  actionItems = (m.actions||[]).slice();
  renderActionItems();
  editingMeeting = i;
  $('cancelMeeting').style.display = 'inline-block';
}

async function deleteMeeting(i){
  if(!confirm('Delete this meeting?')) return;
  const d = await db();
  d.meetings.splice(i,1);
  
  const success = await saveDB(d);
  if (success) {
    renderMeetingsRange();
    refreshSummary();
  }
}

/* PDF helpers */
function hdr(doc, title){
  doc.setFillColor(6,40,61); doc.rect(0,0,210,20,'F');
  doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(13);
  doc.text('GEMS Milandhoo School', 14, 13);
  doc.setFontSize(11); doc.text(title, 196, 13, {align:'right'});
  doc.setTextColor(0,0,0);
}

function ftr(doc){
  const pageCount = doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(9); doc.setTextColor(120);
    doc.text(`Page ${i} / ${pageCount}`, 196, 290, {align:'right'});
    doc.text(new Date().toLocaleString(), 14, 290);
  }
}

function kvGrid(doc, rows, x=14, y=28, colW=46, valW=140){
  doc.setFont('helvetica','bold'); doc.setFontSize(10);
  rows.forEach(([k,v], idx)=>{
    const yy = y + idx*8;
    doc.setDrawColor(225);
    doc.rect(x, yy-6, colW, 8); doc.rect(x+colW, yy-6, valW, 8);
    doc.text(String(k||'-'), x+2, yy);
    doc.setFont('helvetica','normal');
    doc.text(String(v||'-'), x+colW+2, yy, {maxWidth: valW-4});
    doc.setFont('helvetica','bold');
  });
  return y + rows.length*8;
}

/* Single Meeting PDF */
function exportSingleMeetingPDF(index){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'mm', format:'a4'});
  const m = currentData.meetings[index];
  
  if(!m) return alert('Meeting not found');
  hdr(doc, 'Meeting Minutes');

  // Meta grid
  let y = kvGrid(doc,[
    ['Title', m.title],
    ['Date', m.date],
    ['Time', (m.startTime||'') + (m.endTime?(' — '+m.endTime):'')],
    ['Location', m.location||'-'],
    ['Participants', (m.participants||[]).join(', ')||'-']
  ]);

  y += 6; doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text('Agenda', 14, y); y += 2;
  doc.setDrawColor(220); doc.rect(14, y+2, 182, 32);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(m.agenda||'-', 16, y+8, {maxWidth:178}); y += 40;

  doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text('Key Decisions', 14, y); y += 2;
  doc.setDrawColor(220); doc.rect(14, y+2, 182, 32);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.text(m.decisions||'-', 16, y+8, {maxWidth:178}); y += 40;

  // Action items table
  const actions = (m.actions||[]).map((a,i)=>({
    '#': i+1,
    Description: a.text||'-',
    Owner: a.owner||'-',
    Due: a.due||'-',
    Status: a.status||'-'
  }));
  
  if(actions.length){
    doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text('Action Items', 14, y);
    y += 4;
    doc.autoTable({
      startY: y,
      head: [['#','Description','Owner','Due','Status']],
      body: actions.map(a=>[a['#'], a.Description, a.Owner, a.Due, a.Status]),
      styles: {fontSize:10, cellPadding:2},
      headStyles:{fillColor:[6,40,61]},
      theme:'striped',
      margin:{left:14, right:14}
    });
    y = doc.lastAutoTable.finalY + 4;
  }

  // Signature block
  y += 10; doc.setDrawColor(0);
  doc.line(14, y, 94, y); doc.text('Leading Teacher Signature ', 14, y+5);

  ftr(doc);
  doc.save(`Meeting_${m.date}_${(m.title||'').slice(0,24).replace(/[^a-z0-9]+/gi,'_')}.pdf`);
}

/* Range export */
async function exportMeetingsRangePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'mm', format:'a4'});
  const start = $('mtStart').value;
  const end = $('mtEnd').value;
  const d = await db();
  const items = d.meetings.filter(m => (!start || m.date>=start) && (!end || m.date<=end));
  
  if(!items.length) return alert('No meetings in range');

  items.forEach((m, idx) => {
    if(idx>0) doc.addPage();
    hdr(doc, 'Meeting Minutes');
    let y = kvGrid(doc,[
      ['Title', m.title],
      ['Date', m.date],
      ['Time', (m.startTime||'') + (m.endTime?(' — '+m.endTime):'')],
      ['Location', m.location||'-'],
      ['Participants', (m.participants||[]).join(', ')||'-']
    ]);

    y += 6; doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text('Agenda', 14, y); y += 4;
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    const agendaY = doc.splitTextToSize(m.agenda||'-', 180);
    doc.text(agendaY, 14, y); y += Math.min(agendaY.length*5, 40);

    y += 2; doc.setFont('helvetica','bold'); doc.text('Key Decisions', 14, y); y += 4;
    doc.setFont('helvetica','normal'); const decY = doc.splitTextToSize(m.decisions||'-', 180);
    doc.text(decY, 14, y); y += Math.min(decY.length*5, 40);

    const actions = (m.actions||[]).map((a,i)=>({ '#': i+1, Description:a.text||'-', Owner:a.owner||'-', Due:a.due||'-', Status:a.status||'-'}));
    if(actions.length){
      y += 2; doc.setFont('helvetica','bold'); doc.text('Action Items', 14, y); y += 2;
      doc.autoTable({
        startY: y,
        head: [['#','Description','Owner','Due','Status']],
        body: actions.map(a=>[a['#'], a.Description, a.Owner, a.Due, a.Status]),
        styles:{fontSize:10, cellPadding:2},
        headStyles:{fillColor:[6,40,61]},
        theme:'striped',
        margin:{left:14, right:14}
      });
    }
  });

  ftr(doc);
  doc.save('Meeting_Minutes_Range.pdf');
}

/* -------------------------
   Lessons
   ------------------------- */
let editingLesson = null;

function bindLessonForm(){
  $('lessonForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const d = await db();
    
    const rec = {
      date: $('lsDate').value,
      student: $('lsStudent').value.trim(),
      subject: $('lsSubject').value.trim(),
      topic: $('lsTopic').value.trim(),
      objectives: $('lsObjectives').value.trim(),
      materials: $('lsMaterials').value.trim(),
      activities: $('lsActivities').value.trim(),
      homework: $('lsHomework').value.trim()
    };
    
    if(!rec.date || !rec.student || !rec.subject || !rec.topic) return alert('Date, Student, Subject and Lesson Name required');
    
    if(editingLesson === null) d.lessons.push(rec);
    else d.lessons[editingLesson] = rec;
    
    const success = await saveDB(d);
    if (success) {
      cancelEdit('lesson');
      renderLessonsRange();
      refreshSummary();
    }
  });
}

function populateStudentSelect(){
  const sel = $('lsStudent');
  sel.innerHTML = '<option value="">-- choose student --</option>';
  
  currentData.students.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.name;
    opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

async function renderLessonsRange(){
  const start = $('lsStart').value;
  const end = $('lsEnd').value;
  const d = await db();
  const tbody = $('lessonsTable').querySelector('tbody');
  tbody.innerHTML = '';
  
  d.lessons.forEach((l, i) => {
    if((!start || l.date>=start) && (!end || l.date<=end)){
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${l.date}</td><td>${esc(l.student)}</td><td>${esc(l.subject)}</td><td>${esc(l.topic)}</td>
        <td>${esc(l.objectives)}</td><td>${esc(l.materials)}</td><td>${esc(l.activities)}</td><td>${esc(l.homework)}</td>
        <td>
          <button class="action-btn edit" onclick="editLesson(${i})">Edit</button>
          <button class="action-btn del" onclick="deleteLesson(${i})">Delete</button>
        </td>
      </tr>`);
    }
  });
}

function editLesson(i){
  const l = currentData.lessons[i];
  if(!l) return;
  
  $('lsDate').value = l.date;
  $('lsStudent').value = l.student;
  $('lsSubject').value = l.subject;
  $('lsTopic').value = l.topic;
  $('lsObjectives').value = l.objectives;
  $('lsMaterials').value = l.materials;
  $('lsActivities').value = l.activities;
  $('lsHomework').value = l.homework;
  
  editingLesson = i;
  $('cancelLesson').style.display = 'inline-block';
}

async function deleteLesson(i){
  if(!confirm('Delete this lesson?')) return;
  const d = await db();
  d.lessons.splice(i,1);
  
  const success = await saveDB(d);
  if (success) {
    renderLessonsRange();
    refreshSummary();
  }
}

async function exportLessonsPDF(){
  const { jsPDF } = window.jspdf;
  const start = $('lsStart').value;
  const end = $('lsEnd').value;
  const d = await db();
  const items = d.lessons.filter(l => (!start || l.date>=start) && (!end || l.date<=end));
  
  if(!items.length) return alert('No lessons to export in range');
  const doc = new jsPDF({unit:'mm', format:'a4'});
  
  items.forEach((l, idx) => {
    if(idx>0) doc.addPage();
    drawLessonTemplate(doc, l);
  });
  
  doc.save('Lesson_Plans.pdf');
}

function drawLessonTemplate(doc, l){
  hdr(doc, 'Lesson Plan');
  const LM = 14, RM = 196;
  let y = 28;

  // Basic info box
  doc.rect(LM, y, RM-LM, 32);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  doc.rect(LM, y, 52, 16); doc.text('Subject', LM+4, y+11);
  doc.rect(LM+52, y, RM-LM-52, 16); doc.text(l.subject || '-', LM+56, y+11);
  doc.rect(LM, y+16, 52, 16); doc.text('Name of Lesson', LM+4, y+28);
  doc.rect(LM+52, y+16, RM-LM-52, 16); doc.text(l.topic || '-', LM+56, y+28);
  y += 40;

  // Description & objectives box
  const boxH = 150; doc.rect(LM, y, RM-LM, boxH);
  doc.rect(LM, y, 52, boxH/2); doc.text('General Description', LM+4, y+10);
  doc.rect(LM, y+boxH/2, 52, boxH/2); doc.text('Objective(s)', LM+4, y+boxH/2+10);

  const RX = LM+52, RW = RM-RX; doc.rect(RX, y, RW, boxH/2);
  doc.setFont('helvetica','normal'); doc.setFontSize(10);
  const descLines = doc.splitTextToSize(l.objectives || '-', RW-6);
  let cy = y + 10;
  descLines.forEach(line => {
    doc.text(line, RX+3, cy);
    cy += 5;
    if(cy > 280){ doc.addPage(); cy = 20; }
  });

  doc.rect(RX, y+boxH/2, RW, boxH/2);
  let ry = y+boxH/2 + 8;
  doc.setFont('helvetica','bold'); doc.text('Materials:', RX+3, ry); ry += 5;
  doc.setFont('helvetica','normal'); ry = writeWrapped(doc, l.materials || '-', RX+3, ry, RW-6) + 4;
  doc.setFont('helvetica','bold'); doc.text('Activities:', RX+3, ry); ry += 5;
  doc.setFont('helvetica','normal'); ry = writeWrapped(doc, l.activities || '-', RX+3, ry, RW-6) + 4;
  doc.setFont('helvetica','bold'); doc.text('Homework:', RX+3, ry); ry += 5;
  doc.setFont('helvetica','normal'); writeWrapped(doc, l.homework || '-', RX+3, ry, RW-6);

  doc.setFontSize(10); doc.setFont('helvetica','normal');
  doc.text(`Date: ${l.date || '-'}`, LM, 285);
  doc.text(`Student: ${l.student || '-'}`, 110, 285);
  ftr(doc);
}

function writeWrapped(doc, text, x, y, maxW){
  const lines = doc.splitTextToSize(text, maxW);
  let cy = y;
  lines.forEach(line => {
    doc.text(line, x, cy);
    cy += 5;
    if(cy > 280){ doc.addPage(); cy = 20; }
  });
  return cy;
}

/* -------------------------
   Initialization & binding
   ------------------------- */
async function refreshAll(){
  await refreshSummary();
  await renderStudents();
  await populateStudentSelect();
  await renderMeetingsRange();
  await renderLessonsRange();
}

document.addEventListener('DOMContentLoaded', ()=>{
  ensureStorage();
  bindAuth();
  bindStudentForm();
  bindMeetingForm();
  bindLessonForm();

  $('attDate').value = today();
  $('lsDate').value = today();
  $('mtDate').value = today();

  const logged = localStorage.getItem('loggedInUser');
  if(logged){
    openApp(logged);
  }

  // expose globals for inline buttons
  window.navigate = navigate;
  window.logout = logout;

  window.loadAttendanceForDate = loadAttendanceForDate;
  window.markAll = markAll;
  window.saveAttendance = saveAttendance;
  window.loadAttendanceRange = loadAttendanceRange;
  window.exportAttendanceExcel = exportAttendanceExcel;

  window.renderMeetingsRange = renderMeetingsRange;
  window.editMeeting = editMeeting;
  window.deleteMeeting = deleteMeeting;
  window.exportMeetingsRangePDF = exportMeetingsRangePDF;
  window.exportSingleMeetingPDF = exportSingleMeetingPDF;

  window.renderLessonsRange = renderLessonsRange;
  window.populateStudentSelect = populateStudentSelect;
  window.editLesson = editLesson;
  window.deleteLesson = deleteLesson;
  window.exportLessonsPDF = exportLessonsPDF;

  window.addActionItem = addActionItem;
  window.removeActionItem = removeActionItem;
});
</script>

</html>
