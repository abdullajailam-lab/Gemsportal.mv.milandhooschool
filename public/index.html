<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GEMS School Portal â€” Supabase Fixed</title>
  <!-- TailwindCSS for quick, professional styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF for PDF exports -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Day.js for date helpers (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <style>
    /* Simple print-friendly tweaks */
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Top Bar -->
  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold tracking-tight">GEMS School Portal</h1>
      <div class="text-sm text-gray-500">Supabase Powered</div>
    </div>
  </header>

  <!-- App Container -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Supabase Config Card -->
    <section class="bg-white rounded-2xl p-5 shadow-sm border">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Configuration</h2>
        <span class="text-xs text-gray-500">Enter your Supabase keys then click Connect</span>
      </div>
      <div class="grid md:grid-cols-3 gap-3 mt-3">
        <input id="sbUrl" class="border rounded-xl px-3 py-2" placeholder="Supabase URL (https://xxxx.supabase.co)"/>
        <input id="sbKey" class="border rounded-xl px-3 py-2" placeholder="Supabase anon key"/>
        <button id="connectBtn" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500">Connect</button>
      </div>
      <p id="status" class="mt-2 text-sm text-gray-600">Status: <span class="font-medium" id="statusText">Not connected</span></p>
    </section>

    <!-- Nav Tabs -->
    <nav class="no-print bg-white rounded-2xl p-2 shadow-sm border">
      <ul class="flex flex-wrap gap-2" id="tabs">
        <li><button data-tab="dashboard" class="tab px-4 py-2 rounded-xl bg-indigo-600 text-white">Dashboard</button></li>
        <li><button data-tab="students" class="tab px-4 py-2 rounded-xl hover:bg-gray-100">Students</button></li>
        <li><button data-tab="attendance" class="tab px-4 py-2 rounded-xl hover:bg-gray-100">Attendance</button></li>
        <li><button data-tab="meetings" class="tab px-4 py-2 rounded-xl hover:bg-gray-100">Meeting Minutes</button></li>
        <li><button data-tab="lessons" class="tab px-4 py-2 rounded-xl hover:bg-gray-100">Lesson Plans</button></li>
        <li><button data-tab="reports" class="tab px-4 py-2 rounded-xl hover:bg-gray-100">Reports / Export</button></li>
      </ul>
    </nav>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tab-pane bg-white rounded-2xl p-5 shadow-sm border">
      <h2 class="text-lg font-semibold">Quick Overview</h2>
      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div class="rounded-2xl border p-4">
          <div class="text-sm text-gray-500">Students</div>
          <div id="statStudents" class="text-2xl font-bold">0</div>
        </div>
        <div class="rounded-2xl border p-4">
          <div class="text-sm text-gray-500">Meetings (last 30 days)</div>
          <div id="statMeetings" class="text-2xl font-bold">0</div>
        </div>
        <div class="rounded-2xl border p-4">
          <div class="text-sm text-gray-500">Lessons (last 30 days)</div>
          <div id="statLessons" class="text-2xl font-bold">0</div>
        </div>
      </div>
    </section>

    <!-- STUDENTS -->
    <section id="students" class="tab-pane hidden bg-white rounded-2xl p-5 shadow-sm border">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Students</h2>
        <button id="addStudentBtn" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500">Add Student</button>
      </div>
      <div class="mt-4 grid md:grid-cols-4 gap-3">
        <input id="stName" class="border rounded-xl px-3 py-2" placeholder="Name" />
        <input id="stAge" type="number" class="border rounded-xl px-3 py-2" placeholder="Age" />
        <input id="stGrade" class="border rounded-xl px-3 py-2" placeholder="Grade" />
        <input id="stLevel" class="border rounded-xl px-3 py-2" placeholder="Level" />
      </div>
      <div class="mt-4">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2">Name</th>
              <th class="py-2">Age</th>
              <th class="py-2">Grade</th>
              <th class="py-2">Level</th>
            </tr>
          </thead>
          <tbody id="studentsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ATTENDANCE -->
    <section id="attendance" class="tab-pane hidden bg-white rounded-2xl p-5 shadow-sm border">
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div>
          <h2 class="text-lg font-semibold">Attendance</h2>
          <p class="text-sm text-gray-500">Pick a date and mark each student.</p>
        </div>
        <div class="md:ml-auto flex gap-2 items-end">
          <div>
            <label class="text-sm text-gray-600">Date</label>
            <input id="attDate" type="date" class="border rounded-xl px-3 py-2" />
          </div>
          <button id="attendanceSave" class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500">Save Attendance</button>
        </div>
      </div>
      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2">Student</th>
              <th class="py-2">Status</th>
            </tr>
          </thead>
          <tbody id="attendanceBody"></tbody>
        </table>
      </div>
    </section>

    <!-- MEETINGS -->
    <section id="meetings" class="tab-pane hidden bg-white rounded-2xl p-5 shadow-sm border">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Meeting Minutes</h2>
        <div class="flex gap-2">
          <button id="exportMeetingsBtn" class="rounded-xl px-4 py-2 bg-gray-800 text-white hover:bg-gray-700">Export Selected Range</button>
        </div>
      </div>

      <form id="meetingForm" class="mt-4 grid md:grid-cols-3 gap-3">
        <input id="mtTitle" class="border rounded-xl px-3 py-2" placeholder="Title *" required />
        <input id="mtDate" type="date" class="border rounded-xl px-3 py-2" placeholder="Date *" required />
        <div class="grid grid-cols-2 gap-3">
          <input id="mtStart" type="time" class="border rounded-xl px-3 py-2" placeholder="Start" />
          <input id="mtEnd" type="time" class="border rounded-xl px-3 py-2" placeholder="End" />
        </div>
        <input id="mtLocation" class="border rounded-xl px-3 py-2" placeholder="Location" />
        <input id="mtChair" class="border rounded-xl px-3 py-2" placeholder="Chair" />
        <input id="mtParticipants" class="border rounded-xl px-3 py-2" placeholder="Participants (comma separated)" />
        <textarea id="mtAgenda" class="border rounded-xl px-3 py-2 md:col-span-3" rows="3" placeholder="Agenda"></textarea>
        <textarea id="mtDecisions" class="border rounded-xl px-3 py-2 md:col-span-3" rows="3" placeholder="Decisions"></textarea>

        <!-- Action items builder -->
        <div class="md:col-span-3 border rounded-2xl p-3">
          <div class="flex items-center justify-between">
            <div class="font-medium">Action Items</div>
            <div class="flex gap-2">
              <input id="aiTask" class="border rounded-xl px-3 py-2" placeholder="Task" />
              <input id="aiResp" class="border rounded-xl px-3 py-2" placeholder="Responsible" />
              <input id="aiDue" type="date" class="border rounded-xl px-3 py-2" />
              <button id="addAction" type="button" class="rounded-xl px-3 py-2 bg-indigo-600 text-white">Add</button>
            </div>
          </div>
          <ul id="actionList" class="mt-3 space-y-2"></ul>
        </div>

        <div class="md:col-span-3 flex items-center gap-3">
          <button class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500">Add / Save Meeting</button>
          <span class="text-sm text-gray-500">Professional PDF includes header, sections, and action list.</span>
        </div>
      </form>

      <!-- Range filter for export -->
      <div class="mt-6 grid md:grid-cols-4 gap-3">
        <div>
          <label class="text-sm text-gray-600">From</label>
          <input id="meetFrom" type="date" class="border rounded-xl px-3 py-2 w-full" />
        </div>
        <div>
          <label class="text-sm text-gray-600">To</label>
          <input id="meetTo" type="date" class="border rounded-xl px-3 py-2 w-full" />
        </div>
        <div class="md:col-span-2 flex items-end">
          <button id="loadMeetingsRange" class="rounded-xl px-4 py-2 bg-gray-100 hover:bg-gray-200 border">Preview Range</button>
        </div>
      </div>
      <div id="meetingsRange" class="mt-4"></div>
    </section>

    <!-- LESSONS -->
    <section id="lessons" class="tab-pane hidden bg-white rounded-2xl p-5 shadow-sm border">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Lesson Plans</h2>
        <button id="exportLessonsBtn" class="rounded-xl px-4 py-2 bg-gray-800 text-white hover:bg-gray-700">Export Selected Range</button>
      </div>

      <form id="lessonForm" class="mt-4 grid md:grid-cols-3 gap-3">
        <input id="lsDate" type="date" class="border rounded-xl px-3 py-2" placeholder="Date *" required />
        <select id="lsStudent" class="border rounded-xl px-3 py-2"></select>
        <input id="lsSubject" class="border rounded-xl px-3 py-2" placeholder="Subject *" required />
        <input id="lsTopic" class="border rounded-xl px-3 py-2 md:col-span-3" placeholder="Topic *" required />
        <textarea id="lsObjectives" class="border rounded-xl px-3 py-2 md:col-span-3" rows="3" placeholder="Learning Objectives"></textarea>
        <textarea id="lsMaterials" class="border rounded-xl px-3 py-2 md:col-span-3" rows="3" placeholder="Materials"></textarea>
        <textarea id="lsActivities" class="border rounded-xl px-3 py-2 md:col-span-3" rows="3" placeholder="Activities / Steps"></textarea>
        <textarea id="lsHomework" class="border rounded-xl px-3 py-2 md:col-span-3" rows="3" placeholder="Homework"></textarea>
        <div class="md:col-span-3">
          <button class="rounded-xl px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-500">Add / Save Lesson</button>
        </div>
      </form>

      <!-- Range filter for export -->
      <div class="mt-6 grid md:grid-cols-4 gap-3">
        <div>
          <label class="text-sm text-gray-600">From</label>
          <input id="lessFrom" type="date" class="border rounded-xl px-3 py-2 w-full" />
        </div>
        <div>
          <label class="text-sm text-gray-600">To</label>
          <input id="lessTo" type="date" class="border rounded-xl px-3 py-2 w-full" />
        </div>
        <div class="md:col-span-2 flex items-end">
          <button id="loadLessonsRange" class="rounded-xl px-4 py-2 bg-gray-100 hover:bg-gray-200 border">Preview Range</button>
        </div>
      </div>
      <div id="lessonsRange" class="mt-4"></div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tab-pane hidden bg-white rounded-2xl p-5 shadow-sm border">
      <h2 class="text-lg font-semibold">Reports</h2>
      <p class="text-sm text-gray-600">Use the Export buttons inside each tab for professional PDFs.</p>
    </section>
  </main>

  <!-- App Script (ESM for Supabase v2) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/esm/index.js';

    // ------- State -------
    let supabase = null;
    let actionItems = []; // for meeting form

    // ------- Helpers -------
    const $ = (id) => document.getElementById(id);
    function setStatus(msg, good=false){
      const el = $('statusText');
      el.textContent = msg;
      el.className = good ? 'text-green-600 font-medium' : 'text-amber-600 font-medium';
    }
    function toast(msg){
      setStatus(msg, true);
    }

    // ------- Tabs -------
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('bg-indigo-600','text-white'));
        btn.classList.add('bg-indigo-600','text-white');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
        $(tab).classList.remove('hidden');
      });
    });

    // ------- Supabase Connect -------
    $('connectBtn').addEventListener('click', async ()=>{
      const url = $('sbUrl').value.trim();
      const key = $('sbKey').value.trim();
      if(!url || !key){ setStatus('Enter URL and anon key'); return; }
      supabase = createClient(url, key);
      setStatus('Connected', true);
      await refreshAll();
    });

    async function refreshAll(){
      await Promise.all([
        renderStudents(),
        renderAttendanceTable(),
        renderStats(),
      ]);
      // preload selects
      await populateStudentSelect();
    }

    async function renderStats(){
      if(!supabase) return;
      const since = dayjs().subtract(30,'day').format('YYYY-MM-DD');
      const [st, mt, ls] = await Promise.all([
        supabase.from('students').select('id', { count: 'exact', head: true }),
        supabase.from('meetings').select('id', { count: 'exact', head: true }).gte('date', since),
        supabase.from('lessons').select('id', { count: 'exact', head: true }).gte('date', since),
      ]);
      $('statStudents').textContent = st.count ?? 0;
      $('statMeetings').textContent = mt.count ?? 0;
      $('statLessons').textContent = ls.count ?? 0;
    }

    // ------- Students -------
    $('addStudentBtn').addEventListener('click', async ()=>{
      if(!supabase) return setStatus('Connect to Supabase first');
      const name = $('stName').value.trim();
      const age = parseInt($('stAge').value || '0', 10) || null;
      const grade = $('stGrade').value.trim() || null;
      const level = $('stLevel').value.trim() || null;
      if(!name) return setStatus('Student name required');
      const { error } = await supabase.from('students').insert({ name, age, grade, level });
      if(error) return setStatus('Add student failed: '+error.message);
      $('stName').value=''; $('stAge').value=''; $('stGrade').value=''; $('stLevel').value='';
      toast('Student added');
      await renderStudents();
      await populateStudentSelect();
    });

    async function renderStudents(){
      if(!supabase) return;
      const { data, error } = await supabase.from('students').select('*').order('name');
      if(error) { setStatus('Load students failed: '+error.message); return; }
      const body = $('studentsBody');
      body.innerHTML = '';
      (data||[]).forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 border-b">${s.name}</td>
          <td class="py-2 border-b">${s.age ?? ''}</td>
          <td class="py-2 border-b">${s.grade ?? ''}</td>
          <td class="py-2 border-b">${s.level ?? ''}</td>`;
        body.appendChild(tr);
      });
    }

    async function populateStudentSelect(){
      const sel = $('lsStudent');
      if(!supabase || !sel) return;
      const { data } = await supabase.from('students').select('*').order('name');
      sel.innerHTML = '<option value="">Select student</option>' + (data||[]).map(s=>`<option value="${s.name}">${s.name}</option>`).join('');
    }

    // ------- Attendance -------
    async function renderAttendanceTable(){
      if(!supabase) return;
      const { data, error } = await supabase.from('students').select('name').order('name');
      if(error){ setStatus('Load students for attendance failed: '+error.message); return; }
      const body = $('attendanceBody');
      body.innerHTML = '';
      (data||[]).forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 border-b">${s.name}</td>
          <td class="py-2 border-b">
            <select class="border rounded-xl px-2 py-1" data-student="${s.name}">
              <option value="present">Present</option>
              <option value="absent">Absent</option>
              <option value="late">Late</option>
              <option value="excused">Excused</option>
            </select>
          </td>`;
        body.appendChild(tr);
      });
      $('attDate').value = dayjs().format('YYYY-MM-DD');
    }

    async function saveAttendance(){
      if(!supabase) return setStatus('Connect to Supabase first');
      const dateVal = $('attDate').value;
      if(!dateVal) return setStatus('Pick a date');
      const rows = Array.from(document.querySelectorAll('#attendanceBody select'))
        .map(sel=>({ date: dateVal, student: sel.dataset.student, status: sel.value }));
      if(!rows.length) return setStatus('No students found');
      const { error } = await supabase.from('attendance').insert(rows);
      if(error) return setStatus('Save attendance failed: '+error.message);
      toast('Attendance saved');
    }
    $('attendanceSave').addEventListener('click', async (e)=>{ e.preventDefault(); await saveAttendance(); });

    // ------- Meetings -------
    $('addAction').addEventListener('click', ()=>{
      const task = $('aiTask').value.trim();
      const responsible = $('aiResp').value.trim();
      const due = $('aiDue').value;
      if(!task) return;
      actionItems.push({ task, responsible, due });
      $('aiTask').value=''; $('aiResp').value=''; $('aiDue').value='';
      renderActionItems();
    });

    function renderActionItems(){
      const ul = $('actionList');
      ul.innerHTML = '';
      actionItems.forEach((a,i)=>{
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-gray-50 border rounded-xl px-3 py-2';
        li.innerHTML = `<div><span class="font-medium">${i+1}.</span> ${a.task} <span class="text-gray-500">â†’ ${a.responsible || 'TBD'}</span> ${a.due?`<span class=\"text-gray-500\">(due ${a.due})</span>`:''}</div>
                        <button class="text-sm text-red-600 hover:underline" data-idx="${i}">Remove</button>`;
        ul.appendChild(li);
      });
      ul.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = parseInt(btn.dataset.idx,10);
          actionItems.splice(i,1);
          renderActionItems();
        });
      });
    }

    async function saveMeetings(){
      if(!supabase) return setStatus('Connect to Supabase first');
      const title = $('mtTitle').value.trim();
      const date = $('mtDate').value;
      if(!title || !date) return setStatus('Title and Date required');
      const row = {
        title,
        date,
        start_time: $('mtStart').value || null,
        end_time: $('mtEnd').value || null,
        location: $('mtLocation').value || null,
        chair: $('mtChair').value || null,
        participants: $('mtParticipants').value ? $('mtParticipants').value.split(',').map(s=>s.trim()).filter(Boolean) : null,
        agenda: $('mtAgenda').value || null,
        decisions: $('mtDecisions').value || null,
        actions: actionItems.length ? actionItems : null
      };
      const { error } = await supabase.from('meetings').insert(row);
      if(error) return setStatus('Save meeting failed: '+error.message);
      toast('Meeting saved');
      return true;
    }

    $('meetingForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const ok = await saveMeetings();
      if(ok){
        e.target.reset();
        actionItems = [];
        renderActionItems();
        await renderStats();
      }
    });

    $('loadMeetingsRange').addEventListener('click', async (e)=>{
      e.preventDefault();
      await renderMeetingsRange();
    });

    async function renderMeetingsRange(){
      if(!supabase) return;
      const from = $('meetFrom').value || '1900-01-01';
      const to = $('meetTo').value || '2999-12-31';
      let q = supabase.from('meetings').select('*').order('date');
      q = q.gte('date', from).lte('date', to);
      const { data, error } = await q;
      if(error){ setStatus('Load meetings failed: '+error.message); return; }
      const wrap = $('meetingsRange');
      wrap.innerHTML = (data||[]).map(m => `
        <div class="border rounded-2xl p-4 mb-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${m.title}</div>
            <div class="text-sm text-gray-500">${m.date}${m.start_time?` â€¢ ${m.start_time}`:''}${m.end_time?`â€“${m.end_time}`:''}</div>
          </div>
          <div class="text-sm mt-2"><span class="text-gray-500">Location:</span> ${m.location || '-'}</div>
          <div class="text-sm"><span class="text-gray-500">Chair:</span> ${m.chair || '-'}</div>
          <div class="text-sm"><span class="text-gray-500">Participants:</span> ${(m.participants||[]).join(', ') || '-'}</div>
          <div class="mt-2"><span class="font-medium">Agenda</span><div class="text-sm whitespace-pre-line">${m.agenda || '-'}</div></div>
          <div class="mt-2"><span class="font-medium">Decisions</span><div class="text-sm whitespace-pre-line">${m.decisions || '-'}</div></div>
          <div class="mt-2"><span class="font-medium">Action Items</span>
            <ul class="list-disc ml-5 text-sm">
              ${(m.actions||[]).map(a=>`<li>${a.task} <span class=\"text-gray-500\">â†’ ${a.responsible||'TBD'}${a.due?` (due ${a.due})`:''}</span></li>`).join('') || '<li>-</li>'}
            </ul>
          </div>
        </div>`).join('');
      return data || [];
    }

    $('exportMeetingsBtn').addEventListener('click', async ()=>{
      const meetings = await renderMeetingsRange();
      exportMeetingsRangePDF(meetings||[]);
    });

    // ------- Lessons -------
    $('lessonForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const ok = await saveLessons();
      if(ok){ e.target.reset(); await renderStats(); }
    });

    async function saveLessons(){
      if(!supabase) return setStatus('Connect to Supabase first');
      const date = $('lsDate').value; const student = $('lsStudent').value; const subject = $('lsSubject').value.trim(); const topic = $('lsTopic').value.trim();
      if(!date || !student || !subject || !topic) return setStatus('Fill required fields');
      const row = {
        date, student, subject, topic,
        objectives: $('lsObjectives').value || null,
        materials: $('lsMaterials').value || null,
        activities: $('lsActivities').value || null,
        homework: $('lsHomework').value || null
      };
      const { error } = await supabase.from('lessons').insert(row);
      if(error) return setStatus('Save lesson failed: '+error.message);
      toast('Lesson saved');
      return true;
    }

    $('loadLessonsRange').addEventListener('click', async (e)=>{
      e.preventDefault();
      await renderLessonsRange();
    });

    async function renderLessonsRange(){
      if(!supabase) return;
      const from = $('lessFrom').value || '1900-01-01';
      const to = $('lessTo').value || '2999-12-31';
      const { data, error } = await supabase
        .from('lessons')
        .select('*')
        .gte('date', from)
        .lte('date', to)
        .order('date');
      if(error){ setStatus('Load lessons failed: '+error.message); return; }
      const wrap = $('lessonsRange');
      wrap.innerHTML = (data||[]).map(l => `
        <div class="border rounded-2xl p-4 mb-3">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${l.subject}: ${l.topic}</div>
            <div class="text-sm text-gray-500">${l.date} â€¢ ${l.student}</div>
          </div>
          <div class="mt-2"><span class="font-medium">Objectives</span><div class="text-sm whitespace-pre-line">${l.objectives || '-'}</div></div>
          <div class="mt-2"><span class="font-medium">Materials</span><div class="text-sm whitespace-pre-line">${l.materials || '-'}</div></div>
          <div class="mt-2"><span class="font-medium">Activities</span><div class="text-sm whitespace-pre-line">${l.activities || '-'}</div></div>
          <div class="mt-2"><span class="font-medium">Homework</span><div class="text-sm whitespace-pre-line">${l.homework || '-'}</div></div>
        </div>`).join('');
      return data || [];
    }

    $('exportLessonsBtn').addEventListener('click', async ()=>{
      const lessons = await renderLessonsRange();
      exportLessonsPDF(lessons||[]);
    });

    // ------- PDF Generators (Professional templates) -------
    function exportMeetingsRangePDF(meetings){
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      meetings = meetings || [];
      meetings.forEach((m,i)=>{
        if(i>0) doc.addPage();
        // Header
        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('Meeting Minutes', 105, 15, { align: 'center' });
        doc.setDrawColor(60); doc.line(15, 20, 195, 20);
        doc.setFontSize(11); doc.setFont('helvetica','normal');
        doc.text(`Title: ${m.title||'-'}`, 15, 30);
        doc.text(`Date: ${m.date||'-'}    Time: ${(m.start_time||'')}${m.end_time?`â€“${m.end_time}`:''}`, 15, 37);
        doc.text(`Location: ${m.location||'-'}    Chair: ${m.chair||'-'}`, 15, 44);
        doc.text(`Participants: ${(m.participants||[]).join(', ')||'-'}`, 15, 51);
        // Sections boxed
        const sections = [
          ['Agenda', m.agenda||'-'],
          ['Decisions', m.decisions||'-'],
          ['Action Items', (m.actions||[]).map((a,idx)=>`${idx+1}. ${a.task} â†’ ${a.responsible||'TBD'}${a.due?` (due ${a.due})`:''}`).join('\n') || '-']
        ];
        let y = 60;
        sections.forEach(([title, body])=>{
          doc.setFont('helvetica','bold'); doc.text(title, 15, y);
          y += 4; doc.setFont('helvetica','normal');
          const lines = doc.splitTextToSize(body, 175);
          doc.text(lines, 20, y);
          y += lines.length * 6 + 6;
          doc.setDrawColor(230); doc.rect(15, y - (lines.length * 6 + 12), 180, (lines.length * 6 + 10));
          y += 4;
        });
        // Footer
        doc.setFontSize(9); doc.setTextColor(120);
        doc.text('Generated by GEMS Portal', 105, 287, { align: 'center' });
      });
      if(meetings.length===0){ doc.text('No meetings in selected range.', 20, 30); }
      doc.save('meeting_minutes.pdf');
    }

    function exportLessonsPDF(lessons){
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      lessons = lessons || [];
      lessons.forEach((l,i)=>{
        if(i>0) doc.addPage();
        // Header
        doc.setFont('helvetica','bold'); doc.setFontSize(16);
        doc.text('Lesson Plan', 105, 15, { align: 'center' });
        doc.setDrawColor(60); doc.line(15, 20, 195, 20);
        doc.setFontSize(11); doc.setFont('helvetica','normal');
        doc.text(`Date: ${l.date||'-'}    Student: ${l.student||'-'}`, 15, 30);
        doc.text(`Subject: ${l.subject||'-'}    Topic: ${l.topic||'-'}`, 15, 37);
        // Sections boxed
        const sections = [
          ['Objectives', l.objectives||'-'],
          ['Materials', l.materials||'-'],
          ['Activities', l.activities||'-'],
          ['Homework', l.homework||'-']
        ];
        let y = 50;
        sections.forEach(([title, body])=>{
          doc.setFont('helvetica','bold'); doc.text(title, 15, y);
          y += 4; doc.setFont('helvetica','normal');
          const lines = doc.splitTextToSize(body, 175);
          doc.text(lines, 20, y);
          y += lines.length * 6 + 6;
          doc.setDrawColor(230); doc.rect(15, y - (lines.length * 6 + 12), 180, (lines.length * 6 + 10));
          y += 4;
        });
        // Footer
        doc.setFontSize(9); doc.setTextColor(120);
        doc.text('Generated by GEMS Portal', 105, 287, { align: 'center' });
      });
      if(lessons.length===0){ doc.text('No lessons in selected range.', 20, 30); }
      doc.save('lesson_plans.pdf');
    }

    // ------- SQL Helper (copy to Supabase SQL Editor) -------
    // Run this once in your Supabase project to create tables:
    //
    // create table if not exists public.students (
    //   id uuid primary key default gen_random_uuid(),
    //   name text not null,
    //   age int,
    //   grade text,
    //   level text
    // );
    // create table if not exists public.attendance (
    //   id uuid primary key default gen_random_uuid(),
    //   date date not null,
    //   student text not null,
    //   status text not null
    // );
    // create table if not exists public.meetings (
    //   id uuid primary key default gen_random_uuid(),
    //   date date not null,
    //   start_time text,
    //   end_time text,
    //   title text not null,
    //   location text,
    //   chair text,
    //   participants text[],
    //   agenda text,
    //   decisions text,
    //   actions jsonb
    // );
    // create table if not exists public.lessons (
    //   id uuid primary key default gen_random_uuid(),
    //   date date not null,
    //   student text not null,
    //   subject text not null,
    //   topic text not null,
    //   objectives text,
    //   materials text,
    //   activities text,
    //   homework text
    // );

  </script>
</body>
</html>
