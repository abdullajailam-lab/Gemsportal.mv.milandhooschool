<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GEMS Milandhoo School Portal ‚Äî Pro</title>
    <!-- CDNs -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root{
            --sidebar-a:#06283d; --sidebar-b:#0aa3a3; --accent:#ffd166;
            --card:#ffffff; --muted:#6b7c93; --success:#2ea44f; --danger:#ef5350;
            --radius:12px; --shadow:0 10px 30px rgba(2,6,23,0.12);
            --input-text:#000; --ink:#072031; --bg:#eef6f9;
        }
        *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
        html,body{height:100%;margin:0;background:var(--bg);color:var(--ink)}
        /* App shell */
        .app{display:flex;height:100vh;overflow:hidden}
        .sidebar{
            width:280px;padding:22px;background:linear-gradient(180deg,var(--sidebar-a),var(--sidebar-b));
            color:#fff;display:flex;flex-direction:column;gap:18px;box-shadow:var(--shadow)
        }
        .brand{display:flex;align-items:center;gap:12px}
        .brand .logo{width:48px;height:48px;border-radius:10px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center}
        .brand h1{margin:0;font-size:18px;font-weight:800}
        .nav{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px}
        .nav button{background:transparent;border:none;color:#e9fbfb;padding:12px;border-radius:10px;text-align:left;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .15s}
        .nav button:hover{background:rgba(255,255,255,0.06);transform:translateX(6px)}
        .main{flex:1;padding:20px;overflow:auto}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .title{font-weight:800;font-size:20px;color:#072031}
        .header .note{color:var(--muted)}
        .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
        .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);min-width:160px}
        .big{font-size:20px;font-weight:900;color:#052235}
        .small-note{font-size:13px;color:var(--muted)}
        /* panels & forms */
        .panel{background:#fff;padding:14px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:14px}
        .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea{
            padding:10px;border-radius:10px;border:1px solid #d8e6ee;background:#fff;color:var(--input-text);min-width:160px;font-size:13px;
        }
        textarea{min-height:80px;resize:vertical}
        .btn{padding:10px 12px;border-radius:10px;border:none;background:var(--accent);font-weight:800;cursor:pointer}
        .btn.secondary{background:transparent;border:1px solid #cfdce8}
        .small{padding:8px 10px;font-size:13px;border-radius:8px}
        .table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
        .table th,.table td{padding:10px;border:1px solid #eef4f8;text-align:left;font-size:13px}
        /* section accents */
        .section-att .panel{border-left:6px solid #000}
        .section-meet .panel{border-left:6px solid #000}
        .section-less .panel{border-left:6px solid #000}
        /* ensure inputs have black text */
        .section-att input, .section-att textarea, .section-att select,
        .section-meet input, .section-meet textarea, .section-meet select,
        .section-less input, .section-less textarea, .section-less select { color:#000;background:#fff;border:1px solid #c6d3df; }
        /* action buttons */
        .action-btn{padding:6px 10px;border-radius:8px;color:#fff;border:none;cursor:pointer}
        .edit{background:var(--success)}
        .del{background:var(--danger)}
        .link{background:#5b76ff}
        .hidden{display:none}
        .note{color:var(--muted);font-size:13px}
        @media (max-width:900px){ .sidebar{display:none} .app{flex-direction:column} }
        /* pill badges */
        .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #cfe0ea;font-size:12px;color:#375a74;background:#f6fbfe}
        /* Auth status messages */
        .auth-status {
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }
        .auth-success {
            background-color: rgba(46, 164, 79, 0.2);
            color: #2ea44f;
        }
        .auth-error {
            background-color: rgba(239, 83, 80, 0.2);
            color: #ef5350;
        }
        /* Loading indicator */
        .loading {display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 10px;}
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Fix for login/register buttons */
        #btnLogin, #btnRegister {
            transition: all 0.2s ease;
        }
        #btnLogin:hover, #btnRegister:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #btnLogin:active, #btnRegister:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- LOGIN / REGISTER -->
    <div id="authScreen" style="position:fixed;inset:0;background:linear-gradient(180deg,#071a2b,#0a8b8b);display:flex;align-items:center;justify-content:center;z-index:999">
        <div style="width:480px;background:rgba(255,255,255,0.06);padding:28px;border-radius:14px;color:#fff;box-shadow:0 16px 40px rgba(0,0,0,.5)">
            <h2 style="margin:0 0 8px 0;text-align:center">Welcome to GEMS Milandhoo School Portal</h2>
            <div style="display:flex;gap:12px;margin-top:14px;flex-wrap:wrap">
                <div style="flex:1;min-width:220px">
                    <h3 style="margin:0 0 8px 0">Login</h3>
                    <input id="loginEmail" placeholder="Email" type="email" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px" />
                    <input id="loginPass" placeholder="Password" type="password" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px" />
                    <button id="btnLogin" style="width:100%;padding:10px;border-radius:8px;border:none;background:#ffd166;font-weight:800;color:#000">Login</button>
                    <div id="loginStatus" class="auth-status"></div>
                </div>
                <div style="flex:1;min-width:220px">
                    <h3 style="margin:0 0 8px 0">Register</h3>
                    <input id="regName" placeholder="Full Name" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px" />
                    <input id="regEmail" placeholder="Email" type="email" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px" />
                    <input id="regPass" placeholder="Password (min 6 characters)" type="password" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px" />
                    <button id="btnRegister" style="width:100%;padding:10px;border-radius:8px;border:none;background:#4ce0c9;font-weight:800;color:#003">Register & Sign in</button>
                    <div id="registerStatus" class="auth-status"></div>
                </div>
            </div>
            <p style="text-align:center;margin-top:12px;color:rgba(255,255,255,0.8)">All data is securely stored and shared with other teachers.</p>
        </div>
    </div>

    <!-- APP -->
    <div class="app" id="appRoot" style="display:none">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <div class="logo" aria-hidden>
                    <svg viewBox="0 0 24 24" width="22" height="22"><path d="M12 2 L22 8 L17 22 L7 22 L2 8 Z" fill="white" opacity="0.12" /></svg>
                </div>
                <div>
                    <h1>GEMS Milandhoo</h1>
                    <div class="small-note">School Portal</div>
                </div>
            </div>
            <nav>
                <ul class="nav">
                    <li><button onclick="navigate('dashboard')">üè† Dashboard</button></li>
                    <li><button onclick="navigate('students')">üë• Students</button></li>
                    <li><button onclick="navigate('attendance')">üìã Attendance</button></li>
                    <li><button onclick="navigate('meetings')">üóíÔ∏è Meeting Minutes</button></li>
                    <li><button onclick="navigate('lessons')">üìö Lesson Plans</button></li>
                    <li style="margin-top:12px"><button onclick="logout()" style="background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff;padding:10px;border-radius:8px">Logout</button></li>
                </ul>
            </nav>
            <div style="margin-top:auto">
                <div class="small-note">Logged in as</div>
                <div id="currentUser" style="font-weight:800"></div>
                <div id="saveStatus" class="small-note"></div>
            </div>
        </aside>

        <!-- Main -->
        <main class="main">
            <div class="header">
                <div class="title">GEMS Milandhoo School Portal</div>
                <div class="note" id="currentTime">--</div>
            </div>

            <!-- DASHBOARD -->
            <section id="dashboard" class="card">
                <div style="display:flex;gap:12px;flex-wrap:wrap">
                    <div class="card"><div class="big" id="totalStudents">0</div><div class="small-note">Students</div></div>
                    <div class="card"><div class="big" id="attendanceDays">0</div><div class="small-note">Attendance Days</div></div>
                    <div class="card"><div class="big" id="meetingsCount">0</div><div class="small-note">Meetings</div></div>
                    <div class="card"><div class="big" id="lessonsCount">0</div><div class="small-note">Lesson Plans</div></div>
                </div>
                <div class="panel" style="margin-top:12px">
                    <h3 style="margin:0 0 8px 0">Overview</h3>
                    <p class="small-note">Use the sidebar to manage Students, Attendance, Meeting Minutes and Lesson Plans. All records are saved to the cloud and shared with all teachers.</p>
                </div>
            </section>

            <!-- STUDENTS -->
            <section id="students" class="hidden">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Students Management</h3><div class="small-note">Add / Edit / Delete students</div></div>
                        <div id="studentEditingBadge" class="small-note hidden" style="color:#b55">Editing...</div>
                    </div>
                    <form id="studentForm" style="margin-top:12px">
                        <div class="controls">
                            <input id="stuName" placeholder="Full name" required>
                            <input id="stuAge" type="number" placeholder="Age" min="3">
                            <input id="stuGrade" placeholder="Grade">
                            <input id="stuLevel" placeholder="Level">
                            <button class="btn" type="submit">Add / Save</button>
                            <button id="cancelStudent" class="btn secondary" type="button" style="display:none" onclick="cancelEdit('student')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div><strong>Students List</strong><div class="small-note">Search & manage students below</div></div>
                        <div class="controls">
                            <input id="studentSearch" placeholder="Search name or grade" oninput="renderStudents()">
                            <button class="small" onclick="exportStudentsCSV()">Export CSV</button>
                        </div>
                    </div>
                    <table class="table" id="studentsTable">
                        <thead><tr><th>Name</th><th>Age</th><th>Grade</th><th>Level</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- ATTENDANCE -->
            <section id="attendance" class="hidden section-att">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Attendance</h3><div class="small-note">Black-text fields for clarity</div></div>
                        <div class="controls">
                            <label>Start <input id="attStart" type="date"></label>
                            <label>End <input id="attEnd" type="date"></label>
                            <button class="small" onclick="loadAttendanceRange()">Load Range</button>
                            <button class="small" onclick="exportAttendanceExcel()">Export Excel</button>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="controls">
                        <label>Date <input id="attDate" type="date"></label>
                        <button class="small" onclick="loadAttendanceForDate()">Load Students</button>
                        <button class="small" onclick="saveAttendance()">Save Attendance</button>
                        <div style="margin-left:auto;display:flex;gap:8px">
                            <button class="small" onclick="markAll('Present')">All Present</button>
                            <button class="small" onclick="markAll('Absent')">All Absent</button>
                            <button class="small" onclick="markAll('Holiday')">All Holiday</button>
                        </div>
                    </div>
                    <div class="small-note" style="margin-top:8px">Pick a date, click Load Students, mark statuses, then Save Attendance.</div>
                </div>
                <div class="panel">
                    <table class="table" id="attendanceTable">
                        <thead><tr><th>Date</th><th>Student</th><th>Status</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- MEETINGS (Pro) -->
            <section id="meetings" class="hidden section-meet">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Meeting Minutes</h3><div class="small-note">Professional fields & PDF export</div></div>
                        <div class="controls">
                            <label>Start <input id="mtStart" type="date"></label>
                            <label>End <input id="mtEnd" type="date"></label>
                            <button class="small" onclick="loadMeetingsRange()">Load Range</button>
                            <button class="small" onclick="exportMeetingsRangePDF()">Export Range (PDF)</button>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <form id="meetingForm">
                        <div class="controls">
                            <input id="mtDate" type="date" required>
                            <input id="mtStartTime" type="time" placeholder="Start time">
                            <input id="mtEndTime" type="time" placeholder="End time">
                            <input id="mtTitle" type="text" placeholder="Meeting Title" required>
                            <input id="mtLocation" type="text" placeholder="Location">
                        </div>
                        <div class="controls" style="margin-top:8px">
                            <input id="mtChair" type="text" placeholder="Leading Teacher">
                            <select id="mtParticipants" multiple style="min-width:220px;max-height:110px;overflow:auto"></select>
                            <input id="mtParticipantsFree" type="text" placeholder="Extra participants (comma separated)">
                        </div>
                        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <textarea id="mtAgenda" placeholder="Agenda (bullet points or text)" style="min-height:120px"></textarea>
                            <textarea id="mtDecisions" placeholder="Key Decisions" style="min-height:120px"></textarea>
                        </div>
                        <div style="margin-top:8px">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><strong>Action Items</strong><span class="badge">owner + due + status</span></div>
                            <div class="controls">
                                <input id="aiText" type="text" placeholder="Action item description">
                                <input id="aiOwner" type="text" placeholder="Owner">
                                <input id="aiDue" type="date">
                                <select id="aiStatus">
                                    <option value="Open">Open</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Done">Done</option>
                                </select>
                                <button class="small" type="button" onclick="addActionItem()">Add</button>
                            </div>
                            <table class="table" id="actionsTable" style="margin-top:8px">
                                <thead><tr><th>#</th><th>Description</th><th>Owner</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="margin-top:8px;display:flex;gap:8px">
                            <button class="btn" type="submit">Add / Save Meeting</button>
                            <button id="cancelMeeting" class="btn secondary" type="button" style="display:none" onclick="cancelEdit('meeting')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <table class="table" id="meetingsTable">
                        <thead><tr><th>Date</th><th>Title</th><th>Participants</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- LESSONS -->
            <section id="lessons" class="hidden section-less">
                <div class="panel">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><h3 style="margin:0">Lesson Plans</h3><div class="small-note">Black-text fields ‚Äî export to boxed template PDF</div></div>
                        <div class="controls">
                            <label>Start <input id="lsStart" type="date"></label>
                            <label>End <input id="lsEnd" type="date"></label>
                            <button class="small" onclick="loadLessonsRange()">Load Range</button>
                            <button class="small" onclick="exportLessonsPDF()">Export Lesson Plans (PDF)</button>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <form id="lessonForm">
                        <div class="controls">
                            <input id="lsDate" type="date" required>
                            <select id="lsStudent" required style="min-width:220px"><option value="">-- choose student --</option></select>
                            <input id="lsSubject" placeholder="Subject / Course" required>
                            <input id="lsTopic" placeholder="Name of Lesson" required>
                        </div>
                        <div style="margin-top:10px">
                            <textarea id="lsObjectives" placeholder="Objectives / General description" style="width:100%;min-height:100px"></textarea>
                        </div>
                        <div style="margin-top:10px;display:flex;gap:12px;flex-wrap:wrap">
                            <textarea id="lsMaterials" placeholder="Materials" style="flex:1;min-width:260px"></textarea>
                            <textarea id="lsActivities" placeholder="Activities" style="flex:1;min-width:260px"></textarea>
                        </div>
                        <div style="margin-top:10px">
                            <textarea id="lsHomework" placeholder="Homework" style="width:100%;min-height:60px"></textarea>
                            <div style="margin-top:8px;display:flex;gap:8px">
                                <button class="btn" type="submit">Add / Save Lesson</button>
                                <button id="cancelLesson" class="btn secondary" type="button" style="display:none" onclick="cancelEdit('lesson')">Cancel</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel">
                    <table class="table" id="lessonsTable">
                        <thead><tr><th>Date</th><th>Student</th><th>Subject</th><th>Lesson</th><th>Objectives</th><th>Materials</th><th>Activities</th><th>Homework</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = "https://sasodvdokwybanovtuwl.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhc29kdmRva3d5YmFub3Z0dXdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzMzNTAsImV4cCI6MjA3MDc0OTM1MH0.sUJx73vkjPlKo9m8De6dUNGMcdWjb1vh8hnsMBVMgRQ";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global state
        let currentUser = null;
        let currentData = {
            students: [],
            attendance: [],
            meetings: [],
            lessons: []
        };
        let editingStudent = null;
        let editingMeeting = null;
        let editingLesson = null;
        let actionItems = [];
        let currentAttendanceDate = null;

        /* -------------------------
           AUTHENTICATION
        ------------------------- */
        async function setupAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    openApp();
                }
                supabase.auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        currentUser = session.user;
                        openApp();
                    } else if (event === 'SIGNED_OUT') {
                        location.reload();
                    }
                });
            } catch (error) {
                console.error('Auth setup failed:', error);
                document.getElementById('loginStatus').textContent = 'Connection failed. Check Supabase.';
                document.getElementById('loginStatus').className = 'auth-status auth-error';
            }

            document.getElementById('btnLogin').addEventListener('click', login);
            document.getElementById('btnRegister').addEventListener('click', register);
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;
            const status = document.getElementById('loginStatus');
            if (!email || !password) return (status.textContent = 'Enter email and password');

            status.textContent = 'Logging in...';
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                status.textContent = error.message;
                status.className = 'auth-status auth-error';
            } else {
                status.textContent = 'Login successful!';
                status.className = 'auth-status auth-success';
                currentUser = data.user;
            }
        }

        async function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            const status = document.getElementById('registerStatus');
            if (!name || !email || !password) return (status.textContent = 'All fields required');

            status.textContent = 'Creating account...';
            const { data, error } = await supabase.auth.signUp({
                email, password, options: { data: { full_name: name } }
            });
            if (error) {
                status.textContent = error.message;
                status.className = 'auth-status auth-error';
            } else {
                status.textContent = 'Account created!';
                status.className = 'auth-status auth-success';
                const { error: loginError } = await supabase.auth.signInWithPassword({ email, password });
                if (loginError) alert('Login failed after registration');
                else currentUser = data.user;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
        }

        /* -------------------------
           DATA MANAGEMENT
        ------------------------- */
        async function loadAllData() {
            await Promise.all([
                loadStudents(),
                loadAttendance(),
                loadMeetings(),
                loadLessons()
            ]);
            refreshAll();
        }

        async function loadStudents() {
            const { data, error } = await supabase.from('students').select('*').order('name');
            if (error) {
                console.error('Load students error:', error);
                showStatus(`Load error: ${error.message}`, 'error');
            } else {
                currentData.students = data || [];
                populateStudentSelect();
                populateParticipantSelect();
            }
        }

        async function saveStudents() {
            const { error } = await supabase.from('students').upsert(currentData.students, { onConflict: 'id' });
            if (error) {
                console.error('Save students error:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                return false;
            }
            showStatus('Students saved!');
            return true;
        }

        async function loadAttendance() {
            const { data, error } = await supabase.from('attendance').select('*').order('date', { ascending: false });
            if (error) {
                console.error('Load attendance error:', error);
                showStatus(`Load error: ${error.message}`, 'error');
            } else {
                currentData.attendance = data || [];
            }
        }

        async function saveAttendance() {
            const date = document.getElementById('attDate').value;
            if (!date) return showStatus('Select a date', 'error');

            const records = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).map(row => ({
                date,
                student: row.cells[1].textContent,
                status: row.querySelector('select').value
            }));

            const { error } = await supabase.from('attendance').upsert(records, { onConflict: 'date,student' });
            if (error) {
                console.error('Save attendance error:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                return false;
            }

            await loadAttendance();
            showStatus('Attendance saved!');
            return true;
        }

        async function loadMeetings() {
            const { data, error } = await supabase.from('meetings').select('*').order('date', { ascending: false });
            if (error) {
                console.error('Load meetings error:', error);
                showStatus(`Load error: ${error.message}`, 'error');
            } else {
                currentData.meetings = data || [];
            }
        }

        async function saveMeetings() {
            const meetingData = {
                date: document.getElementById('mtDate').value,
                start_time: document.getElementById('mtStartTime').value,
                end_time: document.getElementById('mtEndTime').value,
                title: document.getElementById('mtTitle').value.trim(),
                location: document.getElementById('mtLocation').value.trim(),
                chair: document.getElementById('mtChair').value.trim(),
                agenda: document.getElementById('mtAgenda').value.trim(),
                decisions: document.getElementById('mtDecisions').value.trim(),
                actions: actionItems
            };

            const selected = Array.from(document.getElementById('mtParticipants').selectedOptions).map(o => o.value);
            const freeText = document.getElementById('mtParticipantsFree').value.split(',').map(p => p.trim()).filter(Boolean);
            meetingData.participants = [...new Set([...selected, ...freeText])];

            const result = editingMeeting !== null
                ? await supabase.from('meetings').update(meetingData).eq('id', currentData.meetings[editingMeeting].id)
                : await supabase.from('meetings').insert([meetingData]);

            if (result.error) {
                console.error('Save meeting error:', result.error);
                showStatus(`Save failed: ${result.error.message}`, 'error');
                return false;
            }

            await loadMeetings();
            showStatus('Meeting saved!');
            return true;
        }

        async function loadLessons() {
            const { data, error } = await supabase.from('lessons').select('*').order('date', { ascending: false });
            if (error) {
                console.error('Load lessons error:', error);
                showStatus(`Load error: ${error.message}`, 'error');
            } else {
                currentData.lessons = data || [];
            }
        }

        async function saveLessons() {
            const lessonData = {
                date: document.getElementById('lsDate').value,
                student: document.getElementById('lsStudent').value,
                subject: document.getElementById('lsSubject').value.trim(),
                topic: document.getElementById('lsTopic').value.trim(),
                objectives: document.getElementById('lsObjectives').value.trim(),
                materials: document.getElementById('lsMaterials').value.trim(),
                activities: document.getElementById('lsActivities').value.trim(),
                homework: document.getElementById('lsHomework').value.trim()
            };

            const result = editingLesson !== null
                ? await supabase.from('lessons').update(lessonData).eq('id', currentData.lessons[editingLesson].id)
                : await supabase.from('lessons').insert([lessonData]);

            if (result.error) {
                console.error('Save lesson error:', result.error);
                showStatus(`Save failed: ${result.error.message}`, 'error');
                return false;
            }

            await loadLessons();
            showStatus('Lesson saved!');
            return true;
        }

        function setupRealtimeUpdates() {
            ['students', 'attendance', 'meetings', 'lessons'].forEach(table => {
                supabase.channel(`${table}-changes`)
                    .on('postgres_changes', { event: '*', schema: 'public', table }, () => {
                        if (table === 'students') loadStudents().then(renderStudents);
                        if (table === 'attendance') loadAttendance();
                        if (table === 'meetings') loadMeetings().then(renderMeetingsRange);
                        if (table === 'lessons') loadLessons().then(renderLessonsRange);
                    })
                    .subscribe();
            });
        }

        /* -------------------------
           UI FUNCTIONS
        ------------------------- */
        function openApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appRoot').style.display = 'flex';
            document.getElementById('currentUser').textContent = currentUser.email;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attDate').value = today;
            document.getElementById('lsDate').value = today;
            document.getElementById('mtDate').value = today;

            loadAllData();
            setupRealtimeUpdates();
            navigate('dashboard');
            updateClock();
            setInterval(updateClock, 60000);
        }

        function updateClock() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }

        function showStatus(message, type = 'info') {
            const el = document.getElementById('saveStatus');
            el.textContent = message;
            el.style.color = type === 'error' ? 'var(--danger)' : 'var(--muted)';
            setTimeout(() => el.textContent = '', 5000);
        }

        function navigate(section) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section).classList.remove('hidden');
            if (section === 'students') renderStudents();
            if (section === 'attendance') renderAttendanceForDate();
            if (section === 'meetings') renderMeetingsRange();
            if (section === 'lessons') { populateStudentSelect(); renderLessonsRange(); }
        }

        function refreshAll() {
            refreshSummary();
            renderStudents();
            renderAttendanceForDate();
            renderMeetingsRange();
            renderLessonsRange();
        }

        function refreshSummary() {
            document.getElementById('totalStudents').textContent = currentData.students.length;
            document.getElementById('attendanceDays').textContent = new Set(currentData.attendance.map(a => a.date)).size;
            document.getElementById('meetingsCount').textContent = currentData.meetings.length;
            document.getElementById('lessonsCount').textContent = currentData.lessons.length;
        }

        function renderStudents() {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';
            const search = (document.getElementById('studentSearch').value || '').toLowerCase();
            currentData.students.filter(s => !search || s.name.toLowerCase().includes(search)).forEach((s, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(s.name)}</td>
                    <td>${s.age || ''}</td>
                    <td>${escapeHtml(s.grade || '')}</td>
                    <td>${escapeHtml(s.level || '')}</td>
                    <td>
                        <button class="action-btn edit" onclick="editStudent(${i})">Edit</button>
                        <button class="action-btn del" onclick="deleteStudent(${i})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function populateStudentSelect() {
            const sel = document.getElementById('lsStudent');
            sel.innerHTML = '<option value="">-- choose student --</option>';
            currentData.students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                sel.appendChild(opt);
            });
        }

        function populateParticipantSelect() {
            const sel = document.getElementById('mtParticipants');
            sel.innerHTML = '';
            currentData.students.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.name;
                opt.textContent = s.name;
                sel.appendChild(opt);
            });
        }

        function loadAttendanceForDate() {
            const date = document.getElementById('attDate').value;
            if (!date) return showStatus('Pick a date', 'error');
            currentAttendanceDate = date;
            renderAttendanceForDate();
        }

        function renderAttendanceForDate() {
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '';
            const map = Object.fromEntries(currentData.attendance.filter(a => a.date === currentAttendanceDate).map(a => [a.student, a.status]));
            currentData.students.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${currentAttendanceDate}</td>
                    <td>${escapeHtml(s.name)}</td>
                    <td><select><option value="Present" ${map[s.name] === 'Present' ? 'selected' : ''}>Present</option>
                        <option value="Absent" ${!map[s.name] || map[s.name] === 'Absent' ? 'selected' : ''}>Absent</option>
                        <option value="Holiday" ${map[s.name] === 'Holiday' ? 'selected' : ''}>Holiday</option></select></td>`;
                tbody.appendChild(tr);
            });
        }

        function markAll(status) {
            document.querySelectorAll('#attendanceTable select').forEach(s => s.value = status);
            showStatus(`All marked as ${status}`);
        }

        function editStudent(i) {
            const s = currentData.students[i];
            document.getElementById('stuName').value = s.name;
            document.getElementById('stuAge').value = s.age || '';
            document.getElementById('stuGrade').value = s.grade || '';
            document.getElementById('stuLevel').value = s.level || '';
            editingStudent = i;
            document.getElementById('cancelStudent').style.display = 'inline-block';
            document.getElementById('studentEditingBadge').classList.remove('hidden');
        }

        async function deleteStudent(i) {
            if (confirm('Delete this student?')) {
                await supabase.from('students').delete().eq('id', currentData.students[i].id);
                await loadStudents();
                renderStudents();
                refreshSummary();
                showStatus('Student deleted');
            }
        }

        function cancelEdit(type) {
            if (type === 'student') {
                editingStudent = null;
                document.getElementById('studentForm').reset();
                document.getElementById('cancelStudent').style.display = 'none';
                document.getElementById('studentEditingBadge').classList.add('hidden');
            } else if (type === 'meeting') {
                editingMeeting = null;
                document.getElementById('meetingForm').reset();
                actionItems = [];
                renderActionItems();
                document.getElementById('cancelMeeting').style.display = 'none';
            } else if (type === 'lesson') {
                editingLesson = null;
                document.getElementById('lessonForm').reset();
                document.getElementById('cancelLesson').style.display = 'none';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // MEETING FUNCTIONS
        function addActionItem() {
            const text = document.getElementById('aiText').value.trim();
            if (!text) return showStatus('Enter action item', 'error');
            actionItems.push({
                text,
                owner: document.getElementById('aiOwner').value.trim(),
                due: document.getElementById('aiDue').value,
                status: document.getElementById('aiStatus').value
            });
            renderActionItems();
            document.getElementById('aiText').value = '';
            document.getElementById('aiOwner').value = '';
            document.getElementById('aiDue').value = '';
            showStatus('Action added');
        }

        function renderActionItems() {
            const tbody = document.querySelector('#actionsTable tbody');
            tbody.innerHTML = '';
            actionItems.forEach((a, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td>${escapeHtml(a.text)}</td>
                    <td>${escapeHtml(a.owner)}</td>
                    <td>${a.due}</td>
                    <td>${a.status}</td>
                    <td><button class="action-btn del" onclick="removeActionItem(${i})">Remove</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removeActionItem(i) {
            actionItems.splice(i, 1);
            renderActionItems();
        }

        function editMeeting(i) {
            const m = currentData.meetings[i];
            document.getElementById('mtDate').value = m.date;
            document.getElementById('mtStartTime').value = m.start_time || '';
            document.getElementById('mtEndTime').value = m.end_time || '';
            document.getElementById('mtTitle').value = m.title;
            document.getElementById('mtLocation').value = m.location || '';
            document.getElementById('mtChair').value = m.chair || '';
            document.getElementById('mtAgenda').value = m.agenda || '';
            document.getElementById('mtDecisions').value = m.decisions || '';
            document.getElementById('mtParticipantsFree').value = Array.isArray(m.participants) ? m.participants.join(', ') : m.participants || '';
            actionItems = m.actions || [];
            renderActionItems();
            editingMeeting = i;
            document.getElementById('cancelMeeting').style.display = 'inline-block';
        }

        async function deleteMeeting(i) {
            if (confirm('Delete this meeting?')) {
                const { error } = await supabase.from('meetings').delete().eq('id', currentData.meetings[i].id);
                if (error) showStatus('Delete failed', 'error');
                else {
                    await loadMeetings();
                    renderMeetingsRange();
                    refreshSummary();
                    showStatus('Meeting deleted');
                }
            }
        }

        function renderMeetingsRange() {
            const tbody = document.querySelector('#meetingsTable tbody');
            tbody.innerHTML = '';
            const start = document.getElementById('mtStart').value;
            const end = document.getElementById('mtEnd').value;
            currentData.meetings.forEach((m, i) => {
                if ((start && m.date < start) || (end && m.date > end)) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.date}</td>
                    <td>${escapeHtml(m.title)}</td>
                    <td>${Array.isArray(m.participants) ? m.participants.join(', ') : m.participants || ''}</td>
                    <td>
                        <button class="action-btn edit" onclick="editMeeting(${i})">Edit</button>
                        <button class="action-btn del" onclick="deleteMeeting(${i})">Delete</button>
                        <button class="action-btn link" onclick="exportSingleMeetingPDF(${i})">PDF</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // LESSON FUNCTIONS
        function editLesson(i) {
            const l = currentData.lessons[i];
            document.getElementById('lsDate').value = l.date;
            document.getElementById('lsStudent').value = l.student;
            document.getElementById('lsSubject').value = l.subject;
            document.getElementById('lsTopic').value = l.topic;
            document.getElementById('lsObjectives').value = l.objectives || '';
            document.getElementById('lsMaterials').value = l.materials || '';
            document.getElementById('lsActivities').value = l.activities || '';
            document.getElementById('lsHomework').value = l.homework || '';
            editingLesson = i;
            document.getElementById('cancelLesson').style.display = 'inline-block';
        }

        async function deleteLesson(i) {
            if (confirm('Delete this lesson?')) {
                const { error } = await supabase.from('lessons').delete().eq('id', currentData.lessons[i].id);
                if (error) showStatus('Delete failed', 'error');
                else {
                    await loadLessons();
                    renderLessonsRange();
                    refreshSummary();
                    showStatus('Lesson deleted');
                }
            }
        }

        function renderLessonsRange() {
            const tbody = document.querySelector('#lessonsTable tbody');
            tbody.innerHTML = '';
            const start = document.getElementById('lsStart').value;
            const end = document.getElementById('lsEnd').value;
            currentData.lessons.forEach((l, i) => {
                if ((start && l.date < start) || (end && l.date > end)) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${l.date}</td>
                    <td>${escapeHtml(l.student)}</td>
                    <td>${escapeHtml(l.subject)}</td>
                    <td>${escapeHtml(l.topic)}</td>
                    <td>${escapeHtml(l.objectives?.substring(0,50) || '')}...</td>
                    <td>${escapeHtml(l.materials?.substring(0,30) || '')}...</td>
                    <td>${escapeHtml(l.activities?.substring(0,30) || '')}...</td>
                    <td>${escapeHtml(l.homework?.substring(0,30) || '')}...</td>
                    <td>
                        <button class="action-btn edit" onclick="editLesson(${i})">Edit</button>
                        <button class="action-btn del" onclick="deleteLesson(${i})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // EXPORTS
        function exportStudentsCSV() {
            const ws = XLSX.utils.json_to_sheet(currentData.students);
            XLSX.writeFile(XLSX.utils.book_new().put({ Worksheets: { Students: ws } }), 'students.csv');
        }

        function exportAttendanceExcel() {
            const ws = XLSX.utils.json_to_sheet(currentData.attendance);
            XLSX.writeFile(XLSX.utils.book_new().put({ Worksheets: { Attendance: ws } }), 'attendance.xlsx');
        }

        function exportMeetingsRangePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.text("MEETING MINUTES REPORT", 105, 20, { align: "center" });
            const start = document.getElementById('mtStart').value;
            const end = document.getElementById('mtEnd').value;
            doc.setFontSize(12); doc.text(`Date Range: ${start} to ${end}`, 105, 30, { align: "center" });
            let y = 45;
            currentData.meetings.filter(m => (!start || m.date >= start) && (!end || m.date <= end)).forEach(m => {
                if (y > 250) { doc.addPage(); y = 20; }
                doc.setFontSize(14); doc.text(`${m.date} - ${m.title}`, 14, y); y += 10;
                doc.setFontSize(10); doc.text(`Time: ${m.start_time || 'N/A'} - ${m.end_time || 'N/A'}`, 14, y); y += 6;
                doc.text(`Location: ${m.location || 'N/A'}`, 14, y); y += 6;
                doc.text(`Chair: ${m.chair || 'N/A'}`, 14, y); y += 6;
                const parts = Array.isArray(m.participants) ? m.participants.join(', ') : m.participants || 'N/A';
                const split = doc.splitTextToSize(`Participants: ${parts}`, 180);
                doc.text(split, 14, y); y += split.length * 6 + 8;
                if (m.agenda) { doc.setFontSize(12); doc.text("Agenda:", 14, y); y += 8; doc.setFontSize(10); const a = doc.splitTextToSize(m.agenda, 180); doc.text(a, 20, y); y += a.length * 6 + 8; }
                if (m.decisions) { doc.setFontSize(12); doc.text("Decisions:", 14, y); y += 8; doc.setFontSize(10); const d = doc.splitTextToSize(m.decisions, 180); doc.text(d, 20, y); y += d.length * 6 + 8; }
                if (m.actions?.length) { doc.setFontSize(12); doc.text("Action Items:", 14, y); y += 8; m.actions.forEach(a => { if (y > 250) { doc.addPage(); y = 20; } const t = `‚Ä¢ ${a.text} (Owner: ${a.owner || 'N/A'}, Due: ${a.due || 'N/A'}, Status: ${a.status || 'N/A'})`; const s = doc.splitTextToSize(t, 170); doc.text(s, 20, y); y += s.length * 6 + 4; }); }
                y += 10;
            });
            for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                doc.setPage(i);
                doc.setFontSize(8); doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i}`, 105, 285, { align: "center" });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 290, { align: "center" });
            }
            doc.save("meetings.pdf");
        }

        function exportLessonsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.text("LESSON PLANS REPORT", 105, 20, { align: "center" });
            const start = document.getElementById('lsStart').value;
            const end = document.getElementById('lsEnd').value;
            doc.setFontSize(12); doc.text(`Date Range: ${start} to ${end}`, 105, 30, { align: "center" });
            let y = 45;
            currentData.lessons.filter(l => (!start || l.date >= start) && (!end || l.date <= end)).forEach(l => {
                if (y > 250) { doc.addPage(); y = 20; }
                doc.setFontSize(14); doc.text(`${l.date} - ${l.student} - ${l.subject}`, 14, y); y += 8;
                doc.setFontSize(12); doc.text(`Topic: ${l.topic || 'N/A'}`, 14, y); y += 8;
                if (l.objectives) { doc.setFontSize(12); doc.text("Objectives:", 14, y); y += 8; doc.setFontSize(10); const o = doc.splitTextToSize(l.objectives, 180); doc.text(o, 20, y); y += o.length * 6 + 8; }
                if (l.materials) { doc.setFontSize(12); doc.text("Materials:", 14, y); y += 8; doc.setFontSize(10); const m = doc.splitTextToSize(l.materials, 180); doc.text(m, 20, y); y += m.length * 6 + 8; }
                if (l.activities) { doc.setFontSize(12); doc.text("Activities:", 14, y); y += 8; doc.setFontSize(10); const a = doc.splitTextToSize(l.activities, 180); doc.text(a, 20, y); y += a.length * 6 + 8; }
                if (l.homework) { doc.setFontSize(12); doc.text("Homework:", 14, y); y += 8; doc.setFontSize(10); const h = doc.splitTextToSize(l.homework, 180); doc.text(h, 20, y); y += h.length * 6 + 8; }
                y += 10;
            });
            for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                doc.setPage(i);
                doc.setFontSize(8); doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i}`, 105, 285, { align: "center" });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 290, { align: "center" });
            }
            doc.save("lessons.pdf");
        }

        function exportSingleMeetingPDF(i) {
            const m = currentData.meetings[i];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(20); doc.text("MEETING MINUTES", 105, 20, { align: "center" });
            let y = 35;
            doc.setFontSize(12); doc.text(`Date: ${m.date}`, 20, y); y += 8;
            doc.text(`Time: ${m.start_time || 'N/A'} - ${m.end_time || 'N/A'}`, 20, y); y += 8;
            doc.text(`Title: ${m.title}`, 20, y); y += 8;
            doc.text(`Location: ${m.location || 'N/A'}`, 20, y); y += 8;
            doc.text(`Chair: ${m.chair || 'N/A'}`, 20, y); y += 8;
            const parts = Array.isArray(m.participants) ? m.participants.join(', ') : m.participants || 'N/A';
            const split = doc.splitTextToSize(`Participants: ${parts}`, 170);
            doc.text(split, 20, y); y += split.length * 6 + 12;
            if (m.agenda) { doc.setFontSize(14); doc.text("Agenda:", 20, y); y += 10; doc.setFontSize(10); const a = doc.splitTextToSize(m.agenda, 170); doc.text(a, 25, y); y += a.length * 6 + 12; }
            if (m.decisions) { doc.setFontSize(14); doc.text("Decisions:", 20, y); y += 10; doc.setFontSize(10); const d = doc.splitTextToSize(m.decisions, 170); doc.text(d, 25, y); y += d.length * 6 + 12; }
            if (m.actions?.length) { doc.setFontSize(14); doc.text("Action Items:", 20, y); y += 10; m.actions.forEach(a => { if (y > 250) { doc.addPage(); y = 20; } const t = `‚Ä¢ ${a.text} (Owner: ${a.owner || 'N/A'}, Due: ${a.due || 'N/A'}, Status: ${a.status || 'N/A'})`; const s = doc.splitTextToSize(t, 170); doc.text(s, 25, y); y += s.length * 6 + 6; }); }
            for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                doc.setPage(i);
                doc.setFontSize(8); doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i}`, 105, 285, { align: "center" });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 290, { align: "center" });
            }
            doc.save(`meeting_${m.date}.pdf`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupAuth();

            document.getElementById('studentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('stuName').value.trim();
                if (!name) return alert('Name required');
                const data = {
                    name,
                    age: parseInt(document.getElementById('stuAge').value) || null,
                    grade: document.getElementById('stuGrade').value.trim(),
                    level: document.getElementById('stuLevel').value.trim()
                };
                if (editingStudent !== null) currentData.students[editingStudent] = data;
                else currentData.students.push(data);
                if (await saveStudents()) {
                    cancelEdit('student');
                    renderStudents();
                    refreshSummary();
                }
            });

            document.getElementById('meetingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!document.getElementById('mtDate').value || !document.getElementById('mtTitle').value) return alert('Date and title required');
                if (await saveMeetings()) {
                    cancelEdit('meeting');
                    renderMeetingsRange();
                    refreshSummary();
                }
            });

            document.getElementById('lessonForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const req = ['lsDate', 'lsStudent', 'lsSubject', 'lsTopic'];
                if (req.some(id => !document.getElementById(id).value)) return alert('Fill all required fields');
                if (await saveLessons()) {
                    cancelEdit('lesson');
                    renderLessonsRange();
                    refreshSummary();
                }
            });

            window.navigate = navigate;
            window.logout = logout;
            window.editStudent = editStudent;
            window.deleteStudent = deleteStudent;
            window.cancelEdit = cancelEdit;
            window.renderStudents = renderStudents;
            window.addActionItem = addActionItem;
            window.removeActionItem = removeActionItem;
            window.loadAttendanceForDate = loadAttendanceForDate;
            window.saveAttendance = saveAttendance;
            window.markAll = markAll;
            window.loadAttendanceRange = renderAttendanceForDate;
            window.exportAttendanceExcel = exportAttendanceExcel;
            window.exportStudentsCSV = exportStudentsCSV;
            window.loadMeetingsRange = renderMeetingsRange;
            window.exportMeetingsRangePDF = exportMeetingsRangePDF;
            window.loadLessonsRange = renderLessonsRange;
            window.exportLessonsPDF = exportLessonsPDF;
            window.exportSingleMeetingPDF = exportSingleMeetingPDF;
            window.editMeeting = editMeeting;
            window.deleteMeeting = deleteMeeting;
            window.editLesson = editLesson;
            window.deleteLesson = deleteLesson;
        });
    </script>
</body>
</html>
